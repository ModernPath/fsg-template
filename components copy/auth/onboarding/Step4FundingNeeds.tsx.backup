"use client";

import React, { useState } from 'react';
import { useTranslations } from 'next-intl';
import { Spinner } from '@/components/ui/spinner';
import { TagCloud } from 'react-tagcloud';
import { ColorOptions } from 'react-tagcloud';
import { CompanyRow } from '../OnboardingFlow';
import CompanySelector from '@/components/ui/CompanySelector';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';

// Interface for the collected questionnaire data
interface QuestionnaireData {
  purpose_cashManagement: string[];
  purpose_growth: string[];
  purpose_structure: string[];
  factoring_monthlyInvoices?: string;
  factoring_paymentDays?: string;
  factoring_customerLocation?: string;
  consolidation_totalAmount?: string;
  consolidation_mainGoal?: string;
  consolidation_collateral?: string;
  companySituation?: string;
  currentRevenue?: string;
  situationDetails?: string;
  fundingAmount?: string;
  collateralOptions: string[];
  collateralDetails?: string;
}

// Props for the component
interface Step4NeedsAssessmentProps {
  t: ReturnType<typeof useTranslations<'Onboarding'>>;
  loading: boolean;
  error: string | null;
  goToStep: (step: number) => void;
  onSubmit: (data: QuestionnaireData) => Promise<void>;
  companyId: string | null;
  userCompanies: CompanyRow[];
  handleCompanyChange: (companyId: string) => void;
  isFetchingCompanies: boolean;
}

// Define base structure with keys and counts
const termCounts = {
  growth: 64,
  funding: 55,
  investment: 40,
  workingCapital: 35,
  acquisition: 30,
  expansion: 28,
  productDevelopment: 25,
  recruitment: 22,
  marketing: 20,
  internationalization: 18,
  loan: 15,
  equityInvestment: 12,
  grant: 10,
};

// Options for react-tagcloud (Updated for Dark Theme)
const tagCloudColorOptions: ColorOptions = {
  luminosity: 'light',
  hue: 'yellow',
};

// UPDATED Style classes for Dark Theme
const textareaClasses = "w-full px-5 py-3 text-lg text-gold-primary bg-gray-very-dark border border-gray-dark rounded-lg focus:ring-gold-primary/20 focus:border-gold-primary focus:bg-black transition-colors placeholder-gray-medium min-h-[150px]";

// Component
export const Step4NeedsAssessment: React.FC<Step4NeedsAssessmentProps> = ({
  t,
  loading,
  error,
  goToStep,
  onSubmit,
  companyId,
  userCompanies,
  handleCompanyChange,
  isFetchingCompanies
}) => {
  const [currentStage, setCurrentStage] = useState(1);
  const [questionnaireData, setQuestionnaireData] = useState<QuestionnaireData>({
    purpose_cashManagement: [],
    purpose_growth: [],
    purpose_structure: [],
    collateralOptions: [],
  });

  // Use a specific translation hook for the new structure
  const t4 = useTranslations('Onboarding.step4_');

  const handleNextStage = () => {
    if (currentStage < 6) {
      setCurrentStage(currentStage + 1);
    }
  };

  const handlePrevStage = () => {
    if (currentStage > 1) {
      setCurrentStage(currentStage - 1);
    }
  };

  const handleCheckboxChange = (group: keyof QuestionnaireData, value: string) => {
    setQuestionnaireData(prev => {
      const currentValues = prev[group] as string[] || [];
      const newValues = currentValues.includes(value)
        ? currentValues.filter(item => item !== value)
        : [...currentValues, value];
      return { ...prev, [group]: newValues };
    });
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setQuestionnaireData(prev => ({ ...prev, [name]: value }));
  };
  
  const handleRadioChange = (name: keyof QuestionnaireData, value: string) => {
    setQuestionnaireData(prev => ({ ...prev, [name]: value }));
  };

  const handleFinalSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    // Validate required fields
    const requiredFields = [
      'purpose_cashManagement', 
      'purpose_growth', 
      'purpose_structure',
      'collateralOptions'
    ];
    
    // Check if at least one option is selected in each required array field
    const isValid = requiredFields.every(field => {
      const values = questionnaireData[field as keyof QuestionnaireData] as string[];
      return values && values.length > 0;
    });
    
    if (!isValid) {
      console.error("Missing required selections");
      // You can add local error state here to display to the user
      return;
    }
    
    console.log("Final Questionnaire Data:", questionnaireData);
    await onSubmit(questionnaireData);
  };

  const renderStageContent = () => {
    switch (currentStage) {
      case 1: // Start
        return (
          <div className="text-center space-y-6 bg-gray-very-dark p-8 rounded-lg border border-gray-dark">
            <h2 className="text-2xl lg:text-3xl font-bold text-gold-primary">{t4('stage1.title')}</h2>
            <p className="text-lg text-gray-light">{t4('stage1.greeting')}</p>
            <p className="text-gray-light">{t4('stage1.confidentiality')}</p>
            <p className="text-gray-light">{t4('stage1.purpose')}</p>
            <p className="text-sm text-gray-medium">{t4('stage1.duration')}</p>
            <p className="text-lg font-semibold text-gold-primary mt-4">{t4('stage1.startPrompt')}</p>
            <Button onClick={handleNextStage} className="mt-4">{t4('stage1.startButton')}</Button>
          </div>
        );
      case 2: // Purpose
        return (
          <div className="space-y-8 bg-gray-very-dark p-8 rounded-lg border border-gray-dark">
            <h2 className="text-xl font-bold text-gold-primary mb-4">{t4('stage2.title')}</h2>
            <p className="text-gray-light mb-6">{t4('stage2.instruction')}</p>
            
            {/* Cash Management */}
            <fieldset className="space-y-3 border border-gray-dark p-4 rounded-md">
              <legend className="text-lg font-medium text-gold-primary mb-2">{t4('stage2.cashManagement.title')}</legend>
              {['option1', 'option2', 'option3', 'option4'].map(key => (
                <div key={key} className="flex items-center space-x-2">
                  <Checkbox
                    id={`cash_${key}`}
                    checked={questionnaireData.purpose_cashManagement.includes(t4(`stage2.cashManagement.${key}`))}
                    onCheckedChange={(checked: boolean) => {
                      if (checked) {
                        handleCheckboxChange('purpose_cashManagement', t4(`stage2.cashManagement.${key}`));
                      } else {
                        handleCheckboxChange('purpose_cashManagement', t4(`stage2.cashManagement.${key}`));
                      }
                    }}
                  />
                  <Label htmlFor={`cash_${key}`} className="text-gray-light">{t4(`stage2.cashManagement.${key}`)}</Label>
                </div>
              ))}
            </fieldset>

            {/* Growth */}
            <fieldset className="space-y-3 border border-gray-dark p-4 rounded-md">
              <legend className="text-lg font-medium text-gold-primary mb-2">{t4('stage2.growth.title')}</legend>
              {['option1', 'option2', 'option3'].map(key => (
                <div key={key} className="flex items-center space-x-2">
                  <Checkbox
                    id={`growth_${key}`}
                    checked={questionnaireData.purpose_growth.includes(t4(`stage2.growth.${key}`))}
                    onCheckedChange={(checked: boolean) => {
                      if (checked) {
                        handleCheckboxChange('purpose_growth', t4(`stage2.growth.${key}`));
                      } else {
                        handleCheckboxChange('purpose_growth', t4(`stage2.growth.${key}`));
                      }
                    }}
                  />
                  <Label htmlFor={`growth_${key}`} className="text-gray-light">{t4(`stage2.growth.${key}`)}</Label>
                </div>
              ))}
            </fieldset>

            {/* Structure */}
            <fieldset className="space-y-3 border border-gray-dark p-4 rounded-md">
              <legend className="text-lg font-medium text-gold-primary mb-2">{t4('stage2.structure.title')}</legend>
              {['option1', 'option2', 'option3'].map(key => (
                <div key={key} className="flex items-center space-x-2">
                  <Checkbox
                    id={`structure_${key}`}
                    checked={questionnaireData.purpose_structure.includes(t4(`stage2.structure.${key}`))}
                    onCheckedChange={(checked: boolean) => {
                      if (checked) {
                        handleCheckboxChange('purpose_structure', t4(`stage2.structure.${key}`));
                      } else {
                        handleCheckboxChange('purpose_structure', t4(`stage2.structure.${key}`));
                      }
                    }}
                  />
                  <Label htmlFor={`structure_${key}`} className="text-gray-light">{t4(`stage2.structure.${key}`)}</Label>
                </div>
              ))}
            </fieldset>

            {/* Conditional Follow-up Questions */}
            {questionnaireData.purpose_cashManagement.includes(t4('stage2.cashManagement.option3')) && (
              <div className="mt-6 space-y-4 border-t border-gray-dark pt-6">
                <h3 className="text-lg font-medium text-gold-primary">{t4('stage2.cashManagement.option3')} - {t('details', { default: 'Details' })}</h3>
                <Input 
                  name="factoring_monthlyInvoices" 
                  placeholder={t4('stage2.followUp.factoring.q1Placeholder')} 
                  onChange={handleInputChange} 
                  value={questionnaireData.factoring_monthlyInvoices || ''} 
                />
                <Input 
                  name="factoring_paymentDays" 
                  placeholder={t4('stage2.followUp.factoring.q2Placeholder')} 
                  onChange={handleInputChange} 
                  value={questionnaireData.factoring_paymentDays || ''}
                />
                <div className="space-y-2">
                  <Label>{t4('stage2.followUp.factoring.q3')}</Label>
                  <RadioGroup 
                    value={questionnaireData.factoring_customerLocation} 
                    onValueChange={(value: string) => handleRadioChange('factoring_customerLocation', value)}
                  >
                    {['finland', 'abroad', 'both'].map(loc => (
                      <div key={loc} className="flex items-center space-x-2">
                        <RadioGroupItem value={loc} id={`factoring_loc_${loc}`} />
                        <Label htmlFor={`factoring_loc_${loc}`}>{t4(`stage2.followUp.factoring.q3Options.${loc}`)}</Label>
                      </div>
                    ))}
                  </RadioGroup>
                </div>
              </div>
            )}
            
            {questionnaireData.purpose_cashManagement.includes(t4('stage2.cashManagement.option4')) && (
              <div className="mt-6 space-y-4 border-t border-gray-dark pt-6">
                <h3 className="text-lg font-medium text-gold-primary">{t4('stage2.cashManagement.option4')} - {t('details', { default: 'Details' })}</h3>
                <Input 
                  name="consolidation_totalAmount" 
                  placeholder={t4('stage2.followUp.consolidation.q1Placeholder')} 
                  onChange={handleInputChange} 
                  value={questionnaireData.consolidation_totalAmount || ''} 
                />
                <Input 
                  name="consolidation_mainGoal" 
                  placeholder={t4('stage2.followUp.consolidation.q2Placeholder')} 
                  onChange={handleInputChange} 
                  value={questionnaireData.consolidation_mainGoal || ''} 
                />
                <Textarea 
                  name="consolidation_collateral" 
                  placeholder={t4('stage2.followUp.consolidation.q3Placeholder')} 
                  onChange={handleInputChange} 
                  value={questionnaireData.consolidation_collateral || ''} 
                />
              </div>
            )}
          </div>
        );
      case 3: // Company Situation
        return (
          <div className="space-y-8 bg-gray-very-dark p-8 rounded-lg border border-gray-dark">
            <h2 className="text-xl font-bold text-gold-primary mb-4">{t4('stage3.title')}</h2>
            <p className="text-gray-light mb-6">{t4('stage3.instruction')}</p>
            <RadioGroup 
              value={questionnaireData.companySituation} 
              onValueChange={(value: string) => handleRadioChange('companySituation', value)}
            >
              {['option1', 'option2', 'option3', 'option4', 'option5', 'option6', 'option7'].map(key => (
                <div key={key} className="flex items-center space-x-2 mb-2">
                  <RadioGroupItem value={t4(`stage3.${key}`)} id={`situation_${key}`} />
                  <Label htmlFor={`situation_${key}`}>{t4(`stage3.${key}`)}</Label>
                </div>
              ))}
            </RadioGroup>
            
            <div className="mt-6 space-y-4">
              <Label htmlFor="currentRevenue">{t4('stage3.currentRevenueLabel')}</Label>
              <Input 
                id="currentRevenue" 
                name="currentRevenue" 
                placeholder={t4('stage3.currentRevenuePlaceholder')} 
                onChange={handleInputChange} 
                value={questionnaireData.currentRevenue || ''}
              />
            </div>
            
            <div className="mt-6 space-y-4">
              <Label htmlFor="situationDetails">{t4('stage3.additionalInfoLabel')}</Label>
              <Textarea 
                id="situationDetails" 
                name="situationDetails" 
                placeholder={t4('stage3.additionalInfoPlaceholder')} 
                onChange={handleInputChange} 
                value={questionnaireData.situationDetails || ''} 
              />
            </div>
          </div>
        );
      case 4: // Funding Amount
        return (
          <div className="space-y-8 bg-gray-very-dark p-8 rounded-lg border border-gray-dark">
            <h2 className="text-xl font-bold text-gold-primary mb-4">{t4('stage4.title')}</h2>
            <p className="text-gray-light mb-6">{t4('stage4.instruction')}</p>
            <div>
              <Label htmlFor="fundingAmount" className="sr-only">{t4('stage4.title')}</Label>
              <Input 
                id="fundingAmount" 
                name="fundingAmount" 
                type="number" 
                placeholder={t4('stage4.amountPlaceholder')} 
                onChange={handleInputChange} 
                value={questionnaireData.fundingAmount || ''} 
                className="text-lg" 
              />
            </div>
          </div>
        );
      case 5: // Collateral
        return (
          <div className="space-y-8 bg-gray-very-dark p-8 rounded-lg border border-gray-dark">
            <h2 className="text-xl font-bold text-gold-primary mb-4">{t4('stage5.title')}</h2>
            <p className="text-gray-light mb-6">{t4('stage5.instruction')}</p>
            
            <fieldset className="space-y-3">
              <legend className="text-lg font-medium text-gold-primary mb-2">{t4('stage5.optionsLabel')}</legend>
              {['option1', 'option2', 'option3', 'option4'].map(key => (
                <div key={key} className="flex items-center space-x-2">
                  <Checkbox
                    id={`collateral_${key}`}
                    checked={(questionnaireData.collateralOptions || []).includes(t4(`stage5.${key}`))}
                    onCheckedChange={(checked: boolean) => {
                      if (checked) {
                        handleCheckboxChange('collateralOptions', t4(`stage5.${key}`));
                      } else {
                        handleCheckboxChange('collateralOptions', t4(`stage5.${key}`));
                      }
                    }}
                  />
                  <Label htmlFor={`collateral_${key}`} className="text-gray-light">{t4(`stage5.${key}`)}</Label>
                </div>
              ))}
            </fieldset>

            <div className="mt-6 space-y-4">
              <Label htmlFor="collateralDetails">{t4('stage5.detailsLabel')}</Label>
              <Textarea 
                id="collateralDetails" 
                name="collateralDetails" 
                placeholder={t4('stage5.detailsPlaceholder')} 
                onChange={handleInputChange} 
                value={questionnaireData.collateralDetails || ''} 
              />
            </div>
          </div>
        );
      case 6: // Submit
        return (
          <form onSubmit={handleFinalSubmit} className="space-y-8 bg-gray-very-dark p-8 rounded-lg border border-gray-dark text-center">
            <h2 className="text-xl font-bold text-gold-primary mb-4">{t4('stage6.title')}</h2>
            <p className="text-gray-light mb-6">{t4('stage6.confirmation')}</p>
            {error && (
              <div className="text-red-400 text-sm p-4 bg-red-900/30 border border-red-500/50 rounded-lg my-4" dangerouslySetInnerHTML={{ __html: error }} />
            )}
            <div className="flex justify-between items-center pt-6">
              <Button type="button" variant="outline" onClick={handlePrevStage} disabled={loading}>
                {t4('navigation.back')}
              </Button>
              <Button type="submit" disabled={loading}>
                {loading ? <Spinner className="h-5 w-5 mr-2" /> : null}
                {loading ? t('saving') : t4('stage6.submitButton')}
              </Button>
            </div>
          </form>
        );
      default:
        return <div>Invalid stage</div>;
    }
  };

  return (
    <div className="w-full max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-20">
      {/* Company Selector (always visible at the top) */}
      <div className="max-w-md mb-12">
        <CompanySelector
          companies={userCompanies}
          selectedCompanyId={companyId}
          onCompanyChange={handleCompanyChange}
          isLoading={isFetchingCompanies}
          label={t('step4.selectCompanyLabel')}
        />
      </div>

      {/* Render the current stage */}
      <div className="mb-8">
        {renderStageContent()}
      </div>

      {/* Navigation Buttons (except for stage 1 start and stage 6 submit) */}
      {currentStage > 1 && currentStage < 6 && (
        <div className="flex justify-between items-center pt-6 mt-8 border-t border-gray-dark">
          <Button variant="outline" onClick={handlePrevStage} disabled={loading}>
            {t4('navigation.back')}
          </Button>
          <Button onClick={handleNextStage} disabled={loading}>
            {t4('navigation.next')}
          </Button>
        </div>
      )}

      {/* Back to Step 3 Button (always visible except stage 1) */}
      {currentStage > 1 && (
        <div className="mt-12 text-center">
          <Button variant="link" className="text-gray-light" onClick={() => goToStep(3)} disabled={loading}>
            {t('back')} {t('to', { default: 'to' })} {t('step3.title', { default: 'Document Upload' })}
          </Button>
        </div>
      )}
    </div>
  );
};

export default Step4NeedsAssessment;